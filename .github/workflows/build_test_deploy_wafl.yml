name: Build, test and deploy WAFL
on:
  push:
    branches:
      - master
      - fixing-wafl-ci
    paths:
      - "wasm-fuzzer/**"
      - ".github/**"

jobs:
  build-local:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: "true"

      - name: Install dependencies
        run: |
          sudo apt-get update
          echo "Installing AFL dependencies & supervisord"
          sudo apt-get install -y supervisor build-essential automake libtool-bin python3-dev git automake flex bison libglib2.0-dev libpixman-1-dev clang python3-setuptools llvm procps

      - name: Setup Java
        uses: actions/setup-java@v1
        with:
          java-version: "11" # The JDK version to make available on the path.
          java-package: jdk # (jre, jdk, or jdk+fx) - defaults to jdk
          #architecture: x64 # (x64 or x86) - defaults to x64

      - name: Checking java
        run: |
          java -version

      - name: Build
        run: |
          cd wasm-fuzzer
          bash ./build.sh

  test-local:
    needs: build-local
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          submodules: "true"

      - name: Test wafl
        run: |
          cd wasm-fuzzer
          bash test_wafl_local.sh ${PWD}/sample-testing-targets/branches2.wasm a 11

  build-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build wafl image
        run: |
          cd wasm-fuzzer
          docker --version
          docker build -t wafl -f Dockerfile .

  test-docker:
    needs: build-docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Push images
        run: |
          docker tag wafl slumps/wafl:latest
          docker login -u="$user" -p="$pass"
          docker push slumps/wafl:latest
        env:
          user: ${{secrets.DOCKER_USER}}
          pass: ${{secrets.DOCKER_PASS}}
